generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model apartment_types {
  id          String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  project_id  String   @db.Uuid
  type_label  String
  unit_sqft   Int?
  unit_count  Int      @default(0)
  rent_budget Decimal? @db.Decimal
  rent_actual Decimal? @db.Decimal
  created_at  DateTime @default(now()) @db.Timestamptz(6)
  vacancy_pct Decimal  @default(5) @db.Decimal
  start_month Int?
  projects    projects @relation(fields: [project_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model retail_spaces {
  id          String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  project_id  String   @db.Uuid
  type_label  String
  unit_sqft   Int?
  unit_count  Int      @default(0)
  rent_budget Decimal? @db.Decimal
  rent_actual Decimal? @db.Decimal
  created_at  DateTime @default(now()) @db.Timestamptz(6)
  vacancy_pct Decimal  @default(5) @db.Decimal
  start_month Int?
  projects    projects @relation(fields: [project_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model cashflow_entries {
  id              String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  project_id      String   @db.Uuid
  month_index     Int
  budget_inflows  Decimal? @db.Decimal
  budget_outflows Decimal? @db.Decimal
  actual_inflows  Decimal? @db.Decimal
  actual_outflows Decimal? @db.Decimal
  notes           String?
  created_at      DateTime @default(now()) @db.Timestamptz(6)
  projects        projects @relation(fields: [project_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model cost_items {
  id                    String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  project_id            String    @db.Uuid
  category              String
  cost_name             String
  amount_usd            Decimal?  @db.Decimal
  payment_month         Int?
  start_month           Int?
  end_month             Int?
  carrying_type         String?
  principal_amount_usd  Decimal?  @db.Decimal
  interest_rate_pct     Decimal?  @db.Decimal
  term_years            Decimal?  @db.Decimal
  interval              String?
  start_date            DateTime? @db.Date
  created_at            DateTime  @default(now()) @db.Timestamptz(6)
  cost_group            String?
  payment_mode          String    @default("single")
  month_list            Json?
  month_percentages     Json?
  measurement_unit      String?
  price_per_unit        Decimal?  @db.Decimal
  units_count           Decimal?  @db.Decimal
  loan_mode             String?
  loan_amount_usd       Decimal?  @db.Decimal
  loan_term_months      Int?
  funding_month         Int?
  repayment_start_month Int?
  interval_unit         String?
  projects              projects  @relation(fields: [project_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model gp_contributions {
  id                 String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  project_id         String   @db.Uuid
  partner            String
  amount_usd         Decimal  @db.Decimal
  contribution_month Int
  holding_pct        Decimal? @db.Decimal  // LLC ownership percentage (0-100)
  created_at         DateTime @default(now()) @db.Timestamptz(6)
  projects           projects @relation(fields: [project_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model parking_types {
  id               String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  project_id       String   @db.Uuid
  type_label       String
  space_count      Int      @default(0)
  monthly_rent_usd Decimal? @db.Decimal
  vacancy_pct      Decimal  @default(5) @db.Decimal
  start_month      Int?
  created_at       DateTime @default(now()) @db.Timestamptz(6)
  projects         projects @relation(fields: [project_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model project_stage_history {
  id         String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  project_id String   @db.Uuid
  from_stage String?
  to_stage   String
  changed_at DateTime @default(now()) @db.Timestamptz(6)
  projects   projects @relation(fields: [project_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model projects {
  id                    String                  @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name                  String
  stage                 String                  @default("planned")
  created_at            DateTime                @default(now()) @db.Timestamptz(6)
  updated_at            DateTime                @default(now()) @db.Timestamptz(6)
  address_line1         String?
  address_line2         String?
  city                  String?
  state                 String?
  zip                   String?
  property_type         String?
  purchase_price_usd    Decimal?                @db.Decimal
  closing_date          DateTime?               @db.Date
  target_units          Int?
  target_sqft           Int?
  description           String?
  deleted_at            DateTime?               @db.Timestamptz(6)
  latitude              Decimal?                @db.Decimal
  longitude             Decimal?                @db.Decimal
  building_image_url    String?
  turnover_pct          Decimal?                @db.Decimal
  turnover_cost_usd     Decimal?                @db.Decimal
  retail_turnover_pct   Decimal?                @db.Decimal
  retail_turnover_cost  Decimal?                @db.Decimal
  start_leasing_date    DateTime?               @db.Date
  stabilized_date       DateTime?               @db.Date
  owner_id              String?                 @db.Uuid
  apartment_types       apartment_types[]
  retail_spaces         retail_spaces[]
  cashflow_entries      cashflow_entries[]
  cost_items            cost_items[]
  gp_contributions      gp_contributions[]
  parking_types         parking_types[]
  project_stage_history project_stage_history[]
  owner                 users?                  @relation("projects_owner", fields: [owner_id], references: [id], onDelete: SetNull)
  project_collaborators project_collaborators[]
  project_documents     project_documents[]
  linked_entity         admin_entities?         @relation("project_entity")
}

model users {
  id                            String                           @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  email                         String                           @unique
  display_name                  String
  password_hash                 String
  is_super_admin                Boolean                          @default(false)
  created_at                    DateTime                         @default(now()) @db.Timestamptz(6)
  updated_at                    DateTime                         @default(now()) @db.Timestamptz(6)
  // Real Estate projects
  owned_projects                projects[]                       @relation("projects_owner")
  collaborations                project_collaborators[]
  // Business projects
  owned_business_projects       business_projects[]              @relation("business_projects_owner")
  business_collaborations       business_project_collaborators[]
  // Trips
  trips                         trips[]                          @relation("trips_owner")
  // Admin Hub
  admin_entities                admin_entities[]                 @relation("admin_entities_owner")
  admin_tax_items               admin_tax_items[]                @relation("admin_tax_items_owner")
  admin_team_members            admin_team_members[]             @relation("admin_team_members_owner")
  admin_engagements             admin_engagements[]              @relation("admin_engagements_owner")
  admin_entity_documents        admin_entity_documents[]         @relation("admin_entity_documents_uploader")
  admin_team_member_payments    admin_team_member_payments[]     @relation("admin_team_member_payments_owner")
}

model project_collaborators {
  id         String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  project_id String   @db.Uuid
  user_id    String   @db.Uuid
  created_at DateTime @default(now()) @db.Timestamptz(6)
  project    projects @relation(fields: [project_id], references: [id], onDelete: Cascade)
  user       users    @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([project_id, user_id])
}

model project_documents {
  id          String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  project_id  String   @db.Uuid
  title       String
  url         String
  category    String
  description String?
  created_at  DateTime @default(now()) @db.Timestamptz(6)
  updated_at  DateTime @default(now()) @updatedAt @db.Timestamptz(6)
  project     projects @relation(fields: [project_id], references: [id], onDelete: Cascade)
}

// ============================================
// BUSINESS PROJECTS (Company Building)
// ============================================

model business_projects {
  id                String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name              String
  description       String?
  stage             String   @default("exploring") // exploring, product_market_fit, unit_economics, sustainable_growth
  stage_entered_at  DateTime @default(now()) @db.Timestamptz(6)
  
  // Company info
  legal_entity_name String?
  legal_entity_type String?  // llc, c_corp, s_corp, partnership, sole_prop
  jurisdiction      String?
  formed_at         DateTime? @db.Date
  
  // Industry/Focus
  industry          String   @default("retail_saas")
  target_market     String?
  
  // Financials summary (denormalized for quick display)
  total_invested    Decimal? @db.Decimal
  current_mrr       Decimal? @db.Decimal
  current_runway    Int?     // months
  
  // Ownership
  owner_id          String?  @db.Uuid
  
  // Metadata
  created_at        DateTime @default(now()) @db.Timestamptz(6)
  updated_at        DateTime @default(now()) @db.Timestamptz(6)
  deleted_at        DateTime? @db.Timestamptz(6)
  
  // Relations
  owner             users?   @relation("business_projects_owner", fields: [owner_id], references: [id], onDelete: SetNull)
  collaborators     business_project_collaborators[]
  documents         business_project_documents[]
  founders          business_project_founders[]
  monthly_metrics   business_project_monthly_metrics[]
  stage_criteria    business_project_stage_criteria[]
  stage_history     business_project_stage_history[]
  packages          subscription_packages[]
}

model business_project_collaborators {
  id         String            @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  project_id String            @db.Uuid
  user_id    String            @db.Uuid
  created_at DateTime          @default(now()) @db.Timestamptz(6)
  project    business_projects @relation(fields: [project_id], references: [id], onDelete: Cascade)
  user       users             @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([project_id, user_id])
}

model business_project_documents {
  id          String            @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  project_id  String            @db.Uuid
  title       String
  url         String
  category    String
  description String?
  created_at  DateTime          @default(now()) @db.Timestamptz(6)
  updated_at  DateTime          @default(now()) @updatedAt @db.Timestamptz(6)
  project     business_projects @relation(fields: [project_id], references: [id], onDelete: Cascade)
}

model business_project_founders {
  id             String            @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  project_id     String            @db.Uuid
  name           String
  role           String
  equity_percent Decimal?          @db.Decimal
  created_at     DateTime          @default(now()) @db.Timestamptz(6)
  project        business_projects @relation(fields: [project_id], references: [id], onDelete: Cascade)
}

model business_project_monthly_metrics {
  id                    String            @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  project_id            String            @db.Uuid
  month                 String            // YYYY-MM format
  
  // Revenue metrics
  mrr                   Decimal?          @db.Decimal
  arr                   Decimal?          @db.Decimal
  revenue_growth_pct    Decimal?          @db.Decimal
  
  // Customer metrics
  total_customers       Int?
  new_customers         Int?
  churned_customers     Int?
  churn_rate_pct        Decimal?          @db.Decimal
  
  // Unit economics
  cac                   Decimal?          @db.Decimal
  ltv                   Decimal?          @db.Decimal
  ltv_cac_ratio         Decimal?          @db.Decimal
  gross_margin_pct      Decimal?          @db.Decimal
  
  // Cash metrics
  cash_balance          Decimal?          @db.Decimal
  burn_rate             Decimal?          @db.Decimal
  runway_months         Int?
  
  // Team
  team_size             Int?
  
  notes                 String?
  created_at            DateTime          @default(now()) @db.Timestamptz(6)
  project               business_projects @relation(fields: [project_id], references: [id], onDelete: Cascade)

  @@unique([project_id, month])
}

model business_project_stage_criteria {
  id           String            @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  project_id   String            @db.Uuid
  stage        String            // which stage this criterion belongs to
  criterion_key String           // e.g., "regular_paying_customers", "low_churn"
  description  String
  completed    Boolean           @default(false)
  completed_at DateTime?         @db.Timestamptz(6)
  notes        String?
  created_at   DateTime          @default(now()) @db.Timestamptz(6)
  project      business_projects @relation(fields: [project_id], references: [id], onDelete: Cascade)

  @@unique([project_id, stage, criterion_key])
}

model business_project_stage_history {
  id         String            @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  project_id String            @db.Uuid
  from_stage String?
  to_stage   String
  changed_at DateTime          @default(now()) @db.Timestamptz(6)
  project    business_projects @relation(fields: [project_id], references: [id], onDelete: Cascade)
}

// Unit Economy - Subscription Packages
model subscription_packages {
  id              String            @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  project_id      String            @db.Uuid
  name            String            // Package name (e.g., "Longevity Monthly")
  description     String?           // Overall package description
  suggested_price Decimal           @db.Decimal  // Monthly price point
  sort_order      Int               @default(0)  // For ordering multiple packages
  created_at      DateTime          @default(now()) @db.Timestamptz(6)
  updated_at      DateTime          @default(now()) @updatedAt @db.Timestamptz(6)
  
  project         business_projects @relation(fields: [project_id], references: [id], onDelete: Cascade)
  items           subscription_package_items[]
}

model subscription_package_items {
  id           String                @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  package_id   String                @db.Uuid
  name         String                // Item name (e.g., "Weekly Meal Delivery")
  metric_type  String                // 'frequency', 'quantity', 'na'
  metric_value String?               // "1/week", "5 meals", null for N/A
  cost         Decimal               @db.Decimal  // Monthly cost to deliver
  sort_order   Int                   @default(0)  // For reordering items
  created_at   DateTime              @default(now()) @db.Timestamptz(6)
  updated_at   DateTime              @default(now()) @updatedAt @db.Timestamptz(6)
  
  package      subscription_packages @relation(fields: [package_id], references: [id], onDelete: Cascade)
}

// ============================================
// TRIPS
// ============================================

model trips {
  id          String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name        String
  destination String?
  start_date  DateTime? @db.Date
  end_date    DateTime? @db.Date
  quarter     String    // e.g., "Q1-2025", "Q2-2025"
  owner_id    String    @db.Uuid
  created_at  DateTime  @default(now()) @db.Timestamptz(6)
  updated_at  DateTime  @default(now()) @updatedAt @db.Timestamptz(6)
  
  owner       users     @relation("trips_owner", fields: [owner_id], references: [id], onDelete: Cascade)
}

// ============================================
// ADMIN HUB (Back Office)
// ============================================

// Legal entities (LLCs, Corps, Trusts, etc.)
model admin_entities {
  id                   String              @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name                 String              // Entity name
  entity_type          String              // llc, c_corp, s_corp, lp, trust, individual
  ein                  String?             // EIN/Tax ID
  state_of_formation   String?             // State where formed
  formation_date       DateTime?           @db.Date
  registered_agent     String?             // Registered agent name
  address              String?             // Primary address
  status               String              @default("active") // active, dissolved, inactive
  notes                String?
  owner_id             String              @db.Uuid
  // Company classification fields
  company_type         String?             // 'regular' | 'holding'
  legal_structure      String?             // 'llc' | 'c_corp'
  tax_status           String?             // 'passthrough' | 'blocked' (only for LLCs)
  linked_project_id    String?             @unique @db.Uuid  // FK to projects table (for auto-created entities)
  created_at           DateTime            @default(now()) @db.Timestamptz(6)
  updated_at           DateTime            @default(now()) @updatedAt @db.Timestamptz(6)
  deleted_at           DateTime?           @db.Timestamptz(6)
  
  owner                users               @relation("admin_entities_owner", fields: [owner_id], references: [id], onDelete: Cascade)
  linked_project       projects?           @relation("project_entity", fields: [linked_project_id], references: [id], onDelete: SetNull)
  parent_relationships admin_entity_ownership[] @relation("child_entity")
  child_relationships  admin_entity_ownership[] @relation("parent_entity")
  tax_items            admin_tax_items[]
  engagements          admin_engagements[]
  documents            admin_entity_documents[]
}

// Entity ownership hierarchy
model admin_entity_ownership {
  id                   String         @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  parent_entity_id     String         @db.Uuid
  child_entity_id      String         @db.Uuid
  ownership_percentage Decimal        @db.Decimal  // 0-100
  notes                String?
  created_at           DateTime       @default(now()) @db.Timestamptz(6)
  
  parent_entity        admin_entities @relation("parent_entity", fields: [parent_entity_id], references: [id], onDelete: Cascade)
  child_entity         admin_entities @relation("child_entity", fields: [child_entity_id], references: [id], onDelete: Cascade)

  @@unique([parent_entity_id, child_entity_id])
}

// Tax items (gifts, contributions, returns, depreciation)
model admin_tax_items {
  id                 String          @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tax_year           Int             // 2024, 2025, etc.
  category           String          // gift, contribution, return, depreciation, deadline, other
  entity_id          String?         @db.Uuid  // Optional entity association
  description        String
  amount_usd         Decimal?        @db.Decimal
  recipient_or_source String?        // Who received/provided
  item_date          DateTime?       @db.Date  // Date of item
  due_date           DateTime?       @db.Date  // For deadlines
  status             String          @default("pending") // pending, filed, completed, overdue
  notes              String?
  owner_id           String          @db.Uuid
  created_at         DateTime        @default(now()) @db.Timestamptz(6)
  updated_at         DateTime        @default(now()) @updatedAt @db.Timestamptz(6)
  
  owner              users           @relation("admin_tax_items_owner", fields: [owner_id], references: [id], onDelete: Cascade)
  entity             admin_entities? @relation(fields: [entity_id], references: [id], onDelete: SetNull)
}

// Team members (external professionals)
model admin_team_members {
  id           String              @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name         String
  role         String              // attorney, cpa, property_manager, banker, insurance_agent, other
  company      String?             // Firm/company name
  email        String?
  phone        String?
  address      String?
  specialty    String?             // Area of expertise
  hourly_rate  Decimal?            @db.Decimal
  notes        String?
  owner_id     String              @db.Uuid
  created_at   DateTime            @default(now()) @db.Timestamptz(6)
  updated_at   DateTime            @default(now()) @updatedAt @db.Timestamptz(6)
  deleted_at   DateTime?           @db.Timestamptz(6)
  
  owner        users               @relation("admin_team_members_owner", fields: [owner_id], references: [id], onDelete: Cascade)
  engagements  admin_engagements[]
  payments     admin_team_member_payments[]
}

// Engagement letters/contracts with team members
model admin_engagements {
  id             String              @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  team_member_id String              @db.Uuid
  entity_id      String?             @db.Uuid  // Optional entity association
  title          String              // Engagement title
  start_date     DateTime?           @db.Date
  end_date       DateTime?           @db.Date
  scope          String?             // Scope of work
  fee_structure  String?             // Fee arrangement description
  document_url   String?             // Link to engagement letter
  status         String              @default("active") // active, expired, terminated
  notes          String?
  owner_id       String              @db.Uuid
  created_at     DateTime            @default(now()) @db.Timestamptz(6)
  updated_at     DateTime            @default(now()) @updatedAt @db.Timestamptz(6)
  
  owner          users               @relation("admin_engagements_owner", fields: [owner_id], references: [id], onDelete: Cascade)
  team_member    admin_team_members  @relation(fields: [team_member_id], references: [id], onDelete: Cascade)
  entity         admin_entities?     @relation(fields: [entity_id], references: [id], onDelete: SetNull)
}

// Payments to team members
model admin_team_member_payments {
  id             String              @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  team_member_id String              @db.Uuid
  invoice_url    String?             // Optional link to invoice document
  amount_usd     Decimal             @db.Decimal
  invoice_date   DateTime?           @db.Date
  payment_date   DateTime            @db.Date
  notes          String?
  owner_id       String              @db.Uuid
  created_at     DateTime            @default(now()) @db.Timestamptz(6)
  
  owner          users               @relation("admin_team_member_payments_owner", fields: [owner_id], references: [id], onDelete: Cascade)
  team_member    admin_team_members  @relation(fields: [team_member_id], references: [id], onDelete: Cascade)
}

// Entity-level documents
model admin_entity_documents {
  id            String         @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  entity_id     String         @db.Uuid
  document_type String         // operating_agreement, tax_return, certificate, contract, other
  name          String         // Document name
  file_url      String         // URL/path to document
  year          Int?           // Optional year (for tax returns, etc.)
  notes         String?
  uploaded_by   String         @db.Uuid
  created_at    DateTime       @default(now()) @db.Timestamptz(6)
  updated_at    DateTime       @default(now()) @updatedAt @db.Timestamptz(6)
  
  entity        admin_entities @relation(fields: [entity_id], references: [id], onDelete: Cascade)
  uploader      users          @relation("admin_entity_documents_uploader", fields: [uploaded_by], references: [id], onDelete: Cascade)
}
